<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Smart Efficiency Map - Beep Beep</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        /* --- PALETTE --- */
        :root {
            --coral: #FCA47C; --sun: #F9D779; --aqua: #23CED9;
            --jade: #A1CCA6; --teal: #097C87; --dark-teal: #054A52;
            --purple: #9B59B6; --bg-gray: #f3f4f6;
        }

        @font-face {
            font-family: 'ZTNature-Medium';
            src: url('ZTNature-Medium.ttf') format('truetype');
            font-weight: normal; font-style: normal;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'ZTNature-Medium', sans-serif;
            background: var(--bg-gray);
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden; /* Prevent scrollbars on body */
        }

        /* --- LAYOUT FIX --- */
        /* Using absolute positioning to ensure map always has size */
        .map-card {
            position: relative;
            width: 95vw; height: 90vh;
            background: #ffffff; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
            overflow: hidden; /* Clip content */
        }

        .map-inner {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
        }

        #map { 
            width: 100%; height: 100%; 
            z-index: 1; 
        }
        
        /* UI Overlays */
        .brand-logo {
            position: absolute; top: 20px; right: 20px; z-index: 5000;
            width: 150px; height: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            pointer-events: none; /* Let clicks pass through */
        }

        .map-toolbar-container { 
            position: absolute; top: 20px; left: 20px; z-index: 5000; 
            width: 320px; 
        }

        .map-toolbar {
            display: flex; gap: 8px; padding: 8px;
            background-color: #027361; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #search-input { flex: 1; padding: 10px; border: none; border-radius: 6px; outline: none; }
        #search-btn { width: 40px; cursor: pointer; border-radius: 6px; border: none; background: #eee; }

        #search-results-dropdown {
            margin-top: 5px; width: 100%; background: white;
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            max-height: 300px; overflow-y: auto; display: none; 
        }
        .search-suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-suggestion-item:hover { background-color: #f9f9f9; }

        /* Sidebar */
        .sidebar {
            position: absolute; top: 80px; left: 20px; bottom: 40px; width: 320px;
            background: white; z-index: 4000; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateX(-360px); transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { background: var(--teal); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }

        /* Trip Card */
        .trip-card { 
            background: white; border-left: 5px solid var(--coral); border-radius: 6px; 
            padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .trip-card:hover { background-color: #f0f8ff; }
        .trip-route { font-weight: 800; color: var(--dark-teal); font-size: 18px; }
        .trip-dest { font-size: 12px; color: #666; }
        .trip-dest::before { content: '‚ûî '; color: #999; }
        .trip-time { font-weight: bold; color: var(--teal); background: #eee; padding: 5px 10px; border-radius: 6px; }

        /* Zoom Controls */
        .custom-zoom-controls {
            position: absolute; bottom: 30px; right: 20px; z-index: 5000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .zoom-btn {
            width: 40px; height: 40px; background: white; border: 2px solid #ccc;
            border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #toggle-label-btn.disabled-mode { background-color: #ffebee; color: red; border-color: red; }

        /* Leaflet Overrides */
        .leaflet-routing-container { display: none; }
        
        /* Icons */
        .custom-bus-icon { border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .bus-active { background-color: var(--coral); }
        .bus-passive { background-color: var(--sun); }
        .bus-route-stop-yellow { background-color: var(--sun); border: 2px solid #fff; z-index: 1000 !important; }
        .bus-live { background-color: var(--purple); border: 2px solid white; z-index: 2000 !important; display: flex; justify-content: center; align-items: center; color: white; font-size: 12px; }
        
        .destination-pin { margin-top: -20px; } /* CSS Fix for anchor */
        .stop-name-label { background: transparent; border: none; box-shadow: none; font-weight: bold; color: #333; text-shadow: 0 0 2px #fff; }

        /* Hide Logic */
        .hide-routes .destination-pin, 
        .hide-routes .leaflet-routePane-pane, 
        .hide-routes .bus-live { display: none !important; }
        .map-disabled { cursor: not-allowed !important; }

    </style>
</head>
<body>

    <div class="map-card">
        <img src="logo.png" alt="Beep Beep" class="brand-logo">
        
        <div class="map-inner" id="map-wrapper">
            <div class="map-toolbar-container">
                <div class="map-toolbar">
                    <input type="text" id="search-input" placeholder="Search stop or address..." />
                    <button id="search-btn">üîç</button>
                </div>
                <div id="search-results-dropdown"></div>
            </div>

            <div id="info-sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h3 style="margin:0" id="sidebar-stop-name">Stop Info</h3>
                    <button class="close-btn" onclick="closeSidebar()">√ó</button>
                </div>
                <div class="sidebar-content" id="sidebar-list"></div>
            </div>

            <div id="map"></div>

            <div class="custom-zoom-controls">
                <button id="toggle-label-btn" class="zoom-btn" title="Toggle Features">üëÅÔ∏è</button>
                <button id="locate-btn" class="zoom-btn" title="Locate Me">üìç</button>
                <button class="zoom-btn" onclick="map.zoomIn()">+</button>
                <button class="zoom-btn" onclick="map.zoomOut()">-</button>
            </div>
        </div>
    </div>

    <script>
        const USE_MOCK_DATA = false; 
        const BACKEND_URL = "http://localhost:8000"; 
        const NOMINATIM_URL = "https://nominatim.openstreetmap.org/search"; 
        const SNAP_RADIUS_METERS = 150; 
        const ABSOLUTE_MIN_WALK = 200; 

        let isPathfindingActive = true; 
        let activeTripPolyline = null; 
        let liveTrackingInterval = null;

        // Icons
        const iconBusRed = L.divIcon({ className: 'custom-bus-icon bus-active', html: '', iconSize: [20, 20] });
        const iconBusGray = L.divIcon({ className: 'custom-bus-icon bus-passive', html: '', iconSize: [20, 20] });
        const iconBusYellow = L.divIcon({ className: 'custom-bus-icon bus-route-stop-yellow', html: '', iconSize: [16, 16] });
        const iconLiveBus = L.divIcon({ className: 'custom-bus-icon bus-live', html: 'üöå', iconSize: [24, 24] });
        
        const iconDestination = L.divIcon({ 
            className: 'destination-pin', 
            html: `<svg width="36" height="48" viewBox="0 0 30 42" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.3));"><path d="M15 0C6.71573 0 0 6.71573 0 15C0 26.25 15 42 15 42C15 42 30 26.25 30 15C30 6.71573 23.2843 0 15 0Z" fill="#E74C3C" stroke="white" stroke-width="2"/><circle cx="15" cy="15" r="4" fill="white"/></svg>`, 
            iconSize: [36, 48], iconAnchor: [18, 48], popupAnchor: [0, -20] 
        });

        // Initialize Map
        var map = L.map('map', { zoomControl: false }).setView([50.99955, 8.00122], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
        
        map.createPane('routePane');
        map.getPane('routePane').style.zIndex = 399;

        var userLatLng = null;
        var userMarker = null;
        var destinationMarker = null;
        var routeControls = []; 
        var allStopsData = []; 
        
        // Layer Groups
        var stopsLayerGroup = L.layerGroup().addTo(map);
        var liveBusLayerGroup = L.layerGroup().addTo(map);

        // Geolocation
        navigator.geolocation.getCurrentPosition(pos => {
            userLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
            map.setView(userLatLng, 15);
            updateUserMarker();
            fetchMapDataFromBackend();
        }, () => {
            userLatLng = L.latLng(51.0, 8.0); // Default
            map.setView(userLatLng, 14);
            updateUserMarker();
            fetchMapDataFromBackend();
        });

        function updateUserMarker() {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(userLatLng, { radius: 8, fillColor: "#2196F3", color: "#FFF", weight: 3, fillOpacity: 1 }).addTo(map);
        }

        // --- CORE FUNCTIONS ---

        async function fetchMapDataFromBackend() {
            if (!isPathfindingActive || activeTripPolyline) return;

            const bounds = map.getBounds();
            const body = {
                north: bounds.getNorth(), south: bounds.getSouth(),
                east: bounds.getEast(), west: bounds.getWest(),
                buffer_meters: 200, max_stops: 200
            };

            try {
                const res = await fetch(`${BACKEND_URL}/map_data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.type === "MapDataResponse") updateMapWithBackendData(data.payload.stops);
            } catch (e) { console.error("Fetch error:", e); }
        }

        function updateMapWithBackendData(stops) {
            stopsLayerGroup.clearLayers();
            allStopsData = [];

            stops.forEach(s => {
                const latLng = L.latLng(s.latitude, s.longitude);
                const marker = L.marker(latLng, {icon: iconBusGray});
                marker.bindPopup(s.stop_name, { offset: [0, -10], autoPan: true });
                
                marker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    openStopSidebar(s.stop_id, s.stop_name);
                    
                    if (isPathfindingActive) {
                        // Reset trip view if active
                        if (activeTripPolyline) {
                            map.removeLayer(activeTripPolyline); activeTripPolyline = null;
                            liveBusLayerGroup.clearLayers();
                            fetchMapDataFromBackend();
                        }
                        processJourney(latLng, true, s.stop_id);
                    } else {
                        clearRoutes();
                    }
                });

                stopsLayerGroup.addLayer(marker);
                allStopsData.push({ stop_id: s.stop_id, stop_name: s.stop_name, latLng: latLng, marker: marker });
            });
        }

        async function openStopSidebar(stopId, stopName) {
            const sb = document.getElementById('info-sidebar');
            const list = document.getElementById('sidebar-list');
            document.getElementById('sidebar-stop-name').innerText = stopName;
            list.innerHTML = '<div class="no-data">Loading trips...</div>';
            sb.classList.add('open');

            try {
                const res = await fetch(`${BACKEND_URL}/station_info?stop_id=${stopId}`);
                const data = await res.json();
                list.innerHTML = '';

                if (data.next_trips && data.next_trips.length) {
                    data.next_trips.sort((a, b) => parseInt(a.estimated_arrival||a.arrival_time) - parseInt(b.estimated_arrival||b.arrival_time));
                    
                    data.next_trips.forEach(t => {
                        // NEW: Use Display Names
                        const name = t.display_route_name || t.route_id;
                        const dest = t.display_headsign || t.trip_id;
                        const time = formatTime(t.estimated_arrival || t.arrival_time);

                        const div = document.createElement('div'); div.className = 'trip-card';
                        div.innerHTML = `
                            <div class="trip-info">
                                <span class="trip-route">${name}</span>
                                <span class="trip-dest">${dest}</span>
                            </div>
                            <div class="trip-time">${time}</div>
                        `;
                        div.onclick = () => visualizeTrip(stopId, t.trip_id);
                        list.appendChild(div);
                    });
                } else {
                    list.innerHTML = '<div class="no-data">No upcoming trips.</div>';
                }
            } catch (e) { list.innerHTML = '<div class="no-data">Error loading data.</div>'; }
        }

        async function visualizeTrip(stopId, tripId) {
            if (!isPathfindingActive) return;

            try {
                const res = await fetch(`${BACKEND_URL}/routes_for_stop?stop_id=${stopId}`);
                const trips = await res.json();
                const target = trips.find(t => t.trip_id == tripId);

                if (!target || !target.full_route_stops) { alert("Route not found"); return; }

                clearRoutes();
                stopsLayerGroup.clearLayers();
                liveBusLayerGroup.clearLayers();
                if(activeTripPolyline) map.removeLayer(activeTripPolyline);

                const coords = target.full_route_stops.map(s => [s.lat, s.lon]);
                activeTripPolyline = L.polyline(coords, { color: 'var(--jade)', weight: 6, opacity: 0.9, pane: 'routePane' }).addTo(map);
                map.fitBounds(activeTripPolyline.getBounds(), {padding: [50,50]});

                // Stops
                target.full_route_stops.forEach(s => {
                    const m = L.marker([s.lat, s.lon], {icon: iconBusYellow});
                    m.bindTooltip(s.name, { permanent: true, direction: 'top', className: 'stop-name-label', offset: [0,-10] });
                    stopsLayerGroup.addLayer(m);
                });

                // Live Bus
                trips.forEach(t => {
                    if (t.last_known_stop && t.route_id === target.route_id) {
                        const stop = target.full_route_stops.find(s => s.stop_id == t.last_known_stop);
                        if (stop) {
                            L.marker([stop.lat, stop.lon], {icon: iconLiveBus}).addTo(liveBusLayerGroup)
                             .bindPopup(`Bus ${t.route_id}`);
                        }
                    }
                });

            } catch (e) { console.error(e); }
        }

        // --- UTILS ---
        function closeSidebar() { document.getElementById('info-sidebar').classList.remove('open'); }
        function formatTime(t) { if(!t||t.length<4)return t; return t.substring(0,2)+":"+t.substring(2,4); }
        
        function clearRoutes() {
            map.closePopup();
            routeControls.forEach(c => map.removeControl(c)); routeControls = [];
            if(destinationMarker) map.removeLayer(destinationMarker);
            if(activeTripPolyline) { map.removeLayer(activeTripPolyline); activeTripPolyline = null; }
            liveBusLayerGroup.clearLayers();
            
            // Reset icons
            allStopsData.forEach(s => { s.marker.setIcon(iconBusGray); s.marker.setZIndexOffset(0); });
        }

        function findNearestStop(latlng) {
            let near = null; let min = Infinity;
            allStopsData.forEach(s => {
                const d = latlng.distanceTo(s.latLng);
                if(d < min) { min = d; near = s; }
            });
            return { stop: near, distance: min };
        }

        function processJourney(dest, snapped, stopId) {
            if(!userLatLng) return;
            clearRoutes();

            const startData = findNearestStop(userLatLng);
            let endStop = snapped ? allStopsData.find(s => s.stop_id == stopId) : findNearestStop(dest).stop;
            let startStop = startData.stop;

            if(snapped && endStop) {
                endStop.marker.openPopup();
            } else {
                destinationMarker = L.marker(dest, {icon: iconDestination}).addTo(map);
                let msg = "Destination";
                if(endStop) msg += `<br><small>Nearest: ${endStop.stop_name}</small>`;
                destinationMarker.bindPopup(msg, {offset:[0,0]}).openPopup();
                if(endStop) openStopSidebar(endStop.stop_id, endStop.stop_name);
            }

            // Decide Bus or Walk
            let useBus = false;
            if (startStop && endStop && startStop !== endStop) {
                const dDirect = userLatLng.distanceTo(dest);
                const dRoute = userLatLng.distanceTo(startStop.latLng) + endStop.latLng.distanceTo(dest);
                if (dDirect > ABSOLUTE_MIN_WALK && dDirect > dRoute) useBus = true;
            }

            const styles = [{color:'#6E8F72', opacity:1, weight:7, className:'routing-line'}, {color:'#A1CCA6', opacity:1, weight:4, dashArray:'1,10', className:'routing-line'}];
            const busStyles = [{color:'#054A52', opacity:0.8, weight:8, className:'routing-line'}, {color:'#23CED9', opacity:1, weight:4, className:'routing-line'}];

            function addRoute(a, b, s, m) {
                const c = L.Routing.control({
                    waypoints: [a, b],
                    router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1', profile: m}),
                    lineOptions: { styles: s, missingRouteStyles: s, pane: 'routePane' },
                    createMarker: () => null, show: false, fitSelectedRoutes: false
                }).addTo(map);
                routeControls.push(c);
            }

            if(!useBus) {
                addRoute(userLatLng, dest, styles, 'walking');
            } else {
                startStop.marker.setIcon(iconBusRed); startStop.marker.setZIndexOffset(1000);
                endStop.marker.setIcon(iconBusRed); endStop.marker.setZIndexOffset(1000);
                
                addRoute(userLatLng, startStop.latLng, styles, 'walking');
                addRoute(startStop.latLng, endStop.latLng, busStyles, 'driving');
                if(!snapped) addRoute(endStop.latLng, dest, styles, 'walking');
            }
            
            const bounds = [userLatLng, dest];
            if(startStop) bounds.push(startStop.latLng);
            if(endStop) bounds.push(endStop.latLng);
            map.fitBounds(L.latLngBounds(bounds), {padding: [80,80]});
        }

        // --- EVENTS ---
        map.on('click', e => {
            if(activeTripPolyline) {
                map.removeLayer(activeTripPolyline); activeTripPolyline=null;
                liveBusLayerGroup.clearLayers();
                fetchMapDataFromBackend();
                closeSidebar();
                return;
            }
            if(!isPathfindingActive) return;

            const res = findNearestStop(e.latlng);
            if(res.stop && res.distance < SNAP_RADIUS_METERS) {
                openStopSidebar(res.stop.stop_id, res.stop.stop_name);
                processJourney(res.stop.latLng, true, res.stop.stop_id);
            } else {
                processJourney(e.latlng, false, null);
            }
        });

        map.on('moveend', () => { if(!activeTripPolyline) fetchMapDataFromBackend(); });

        // Search
        const searchInput = document.getElementById('search-input');
        const searchRes = document.getElementById('search-results-dropdown');
        let debounce;

        searchInput.addEventListener('input', e => {
            if(!isPathfindingActive) return;
            const q = e.target.value.trim();
            searchRes.innerHTML = '';
            if(q.length < 3) { searchRes.style.display='none'; return; }

            clearTimeout(debounce);
            debounce = setTimeout(async () => {
                try {
                    const [stops, places] = await Promise.all([
                        fetch(`${BACKEND_URL}/search_stations?query=${q}`).then(r=>r.json()).catch(()=>[]),
                        fetch(`${NOMINATIM_URL}?format=json&q=${q}&addressdetails=1&limit=5`).then(r=>r.json()).catch(()=>[])
                    ]);
                    searchRes.innerHTML = '';
                    if(stops.length) {
                        searchRes.innerHTML += `<div style="padding:5px;color:#888;font-size:11px;font-weight:bold">STOPS</div>`;
                        stops.forEach(s => {
                            const d = document.createElement('div'); d.className='search-suggestion-item';
                            d.innerText = `üöå ${s.stop_name}`;
                            d.onclick = () => selectSearch(s, 'stop');
                            searchRes.appendChild(d);
                        });
                    }
                    if(places.length) {
                        searchRes.innerHTML += `<div style="padding:5px;color:#888;font-size:11px;font-weight:bold">PLACES</div>`;
                        places.forEach(p => {
                            const d = document.createElement('div'); d.className='search-suggestion-item';
                            d.innerText = `üìç ${p.display_name.split(',')[0]}`;
                            d.onclick = () => selectSearch(p, 'place');
                            searchRes.appendChild(d);
                        });
                    }
                    searchRes.style.display = (stops.length||places.length) ? 'block':'none';
                } catch(e) { console.error(e); }
            }, 300);
        });

        async function selectSearch(item, type) {
            searchInput.value = type==='stop' ? item.stop_name : item.display_name.split(',')[0];
            searchRes.style.display = 'none';
            
            const ll = L.latLng(item.lat||item.latitude, item.lon||item.longitude);
            map.setView(ll, 16);

            if(type==='stop') {
                openStopSidebar(item.stop_id, item.stop_name);
                processJourney(ll, true, item.stop_id);
            } else {
                // Fetch stops around place
                const body = { north: ll.lat+0.01, south: ll.lat-0.01, east: ll.lng+0.01, west: ll.lng-0.01, buffer_meters:200, max_stops:100 };
                try {
                    const res = await fetch(`${BACKEND_URL}/map_data`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
                    const d = await res.json();
                    if(d.type==="MapDataResponse") updateMapWithBackendData(d.payload.stops);
                } catch(e){}
                processJourney(ll, false, null);
            }
        }

        // Toggle
        const toggleBtn = document.getElementById('toggle-label-btn');
        const mapWrap = document.getElementById('map-wrapper');
        toggleBtn.onclick = () => {
            isPathfindingActive = !isPathfindingActive;
            if(!isPathfindingActive) {
                clearRoutes();
                if(activeTripPolyline) { map.removeLayer(activeTripPolyline); activeTripPolyline=null; fetchMapDataFromBackend(); }
                liveBusLayerGroup.clearLayers();
                mapWrap.classList.add('hide-routes');
                toggleBtn.innerText = "üö´"; toggleBtn.classList.add('disabled-mode');
                closeSidebar();
            } else {
                mapWrap.classList.remove('hide-routes');
                toggleBtn.innerText = "üëÅÔ∏è"; toggleBtn.classList.remove('disabled-mode');
                const p = map.getPane('routePane'); p.style.display='block';
            }
        };

        document.getElementById('locate-btn').onclick = () => navigator.geolocation.getCurrentPosition(success, error, {enableHighAccuracy:true});

    </script>
</body>
</html>