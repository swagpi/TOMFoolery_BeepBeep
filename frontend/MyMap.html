<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Transit Map Application</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        /* üé® Tropical Jade Sunrise palette (New) */
        :root {
            --coral: #FCA47C;
            --sun: #F9D779;
            --aqua: #23CED9;
            --jade: #A1CCA6;
            --teal: #097C87;
        }

        /* üñº Frame Setup (New) */
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, sans-serif;
            background: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .map-card {
            overflow: hidden;
            position: relative;
            width: min(1400px, 98vw);
            height: min(820px, 95vh);
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
            padding: 8px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* üîî Logo Badge (New) */
        .brand-badge {
            position: absolute;
            top: 20px;
            right: 26px;
            background: var(--teal);
            color: #ffffff;
            padding: 10px 22px;
            border-radius: 999px;
            border: 4px solid #ffffff;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.22);
            font-size: 17px;
            font-weight: 800;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 0.1em;
            z-index: 10000;
        }

        .brand-badge-dot {
            width: 14px;
            height: 14px;
            border-radius: 999px;
            background: var(--sun);
        }

        /* üó∫ Map Container (Modified to fit the card structure) */
        .map-inner {
            position: relative;
            flex: 1;
            border-radius: 14px;
            overflow: hidden;
        }

        /* Actual Leaflet map div (Modified: absolute positioning removed, relying on map-inner flex/sizing) */
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Hide routing text instructions */
        .leaflet-routing-container { display: none; }

        /* --- MARKER STYLES --- */
        .custom-bus-icon {
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; border: 2px solid white;  
            box-shadow: 0 2px 4px rgba(0,0,0,0.4); font-size: 12px;         
        }
        .bus-active {
            background-color: #ff0000; width: 24px !important; height: 24px !important;
            margin-left: -12px !important; margin-top: -12px !important;
        }
        .bus-passive {
            background-color: #808080; opacity: 0.9;
            width: 20px !important; height: 20px !important;
            margin-left: -10px !important; margin-top: -10px !important;
            font-size: 10px;          
        }

        /* --- CUSTOM ZOOM/LOCATE BUTTON STYLES (Consolidated & Circular) --- */
        .custom-zoom-controls {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column; 
            gap: 10px;
        }

        .zoom-btn {
            width: 45px;
            height: 45px;
            background-color: white;
            border: 2px solid #ccc;
            border-radius: 50%; /* Make all zoom/locate buttons circular */
            font-size: 24px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.1s;
        }

        .zoom-btn:active {
            background-color: #f0f0f0;
            transform: scale(0.95);
        }
        
        /* Locate Button Overrides */
        #locate-btn {
            background-color: var(--teal); /* Using CSS Variable for color */
            color: white;
            border: none;
            /* Note: height, width, border-radius come from .zoom-btn */
        }
        #locate-btn:hover {
            background-color: #1e88e5;
        }

        /* --- SEARCH TOOLBAR STYLES --- */
        
        /* Font Loading (Kept for completeness) */
        @font-face {
            font-family: 'ZTNature-Medium';
            src: url('path/to/ZTNature-Medium.woff2') format('woff2'),
                 url('path/to/ZTNature-Medium.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        /* NEW: Container for Toolbar + Dropdown (Moved inside .map-inner) */
        .map-toolbar-container {
            position: absolute; 
            top: 20px;
            left: 20px;
            z-index: 9999;
            width: 300px; 
        }

        .map-toolbar {
            display: flex;
            gap: 5px;
            padding: 6px;
            background-color: var(--jade); /* Using CSS Variable for background */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        #search-input {
            width: 250px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            font-family: 'ZTNature-Medium', sans-serif; 
        }

        #search-input::placeholder {
            font-family: 'ZTNature-Medium', sans-serif;
            color: #888;
        }

        #search-btn {
            width: 40px;
            height: 40px;
            background-color: #f0f0f0; 
            color: #333;
            border: 1px solid #ccc;
            border-radius: 15px; /* Rounder edges for search button */
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif; 
        }
        
        /* --- SEARCH DROPDOWN STYLES --- */
        #search-results-dropdown {
            position: relative;
            top: 5px;
            width: 100%;
            z-index: 10000;
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            list-style: none;
        }
        
        .search-suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-family: 'ZTNature-Medium', sans-serif;
            font-size: 14px;
            color: #333;
        }
        
        .search-suggestion-item:last-child {
            border-bottom: none;
        }
        
        .search-suggestion-item:hover {
            background-color: #f0f0f0;
        }

    </style>
</head>
<body>

    <div class="map-card">
        <div class="brand-badge">
            <span class="brand-badge-dot"></span>
            <span>beep beep</span>
        </div>

        <div class="map-inner">
            <div id="map"></div>
            
            <div class="map-toolbar-container">
                <div class="map-toolbar">
                    <input type="text" id="search-input" placeholder="Search for a stop or address..." />
                    <button id="search-btn" title="Search">üîç</button>
                </div>
                <div id="search-results-dropdown">
                </div>
            </div>

            <div class="custom-zoom-controls">
                <button id="locate-btn" title="Locate Me" class="zoom-btn">üìç</button>
                <button class="zoom-btn" onclick="map.zoomIn()">+</button>
                <button class="zoom-btn" onclick="map.zoomOut()">-</button>
            </div>
        </div>
    </div>
    <script>
        // --- 1. ICONS ---
        var iconBusRed = L.divIcon({ className: 'custom-bus-icon bus-active', html: 'üöå', iconSize: [24, 24] });
        var iconBusGray = L.divIcon({ className: 'custom-bus-icon bus-passive', html: 'üöå', iconSize: [20, 20] });

        function createUserMarker(latlng) {
            return L.circleMarker(latlng, {
                radius: 8, fillColor: "#2196F3", color: "#FFF", weight: 2, fillOpacity: 1
            });
        }

        // --- 2. MAP SETUP ---
        var map = L.map('map', {
            dragging: true, 
            tap: true, 
            zoomControl: false // Disable default Leaflet zoom control
        }).setView([0,0], 1);

        // Map Tiles: Merged attribution and URL
        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            attribution: '&copy; MapTiler &copy; OpenStreetMap contributors',
            noWrap: true
        }).addTo(map);

        var userLatLng = null;
        var allStopsData = []; 
        var routeControls = []; 
        var destinationMarker = null;
        var userMarker = null;
        
        // --- Global Layer Groups for Search Results ---
        var searchStopMarkers = L.layerGroup().addTo(map);
        var searchRouteLines = L.layerGroup().addTo(map);

        // --- 3. GET LOCATION ---
        navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true });

        function success(position) {
            userLatLng = L.latLng(position.coords.latitude, position.coords.longitude); 
            map.setView(userLatLng, 15);
            userMarker = createUserMarker(userLatLng).addTo(map).bindPopup("<b>You</b>");
            
            generateStaticMockStops(userLatLng);
            logBoundsForBackend();
        }

        function error() { alert("Location could not be retrieved."); }

        // --- 4. BACKEND LOGIC ---
        map.on('moveend', function() { logBoundsForBackend(); });

        function logBoundsForBackend() {
            var bounds = map.getBounds();
            var requestData = {
                topLeft: bounds.getNorthWest(),
                bottomRight: bounds.getSouthEast()
            };
            console.log("üì° Sending Bounds to Backend:", requestData);
        }

        // --- 5. STATIC MOCK DATA ---
        function generateStaticMockStops(center) {
            for (let i = 0; i < 30; i++) { 
                let latOffset = (Math.random() - 0.5) * 0.04;
                let lngOffset = (Math.random() - 0.5) * 0.04;
                let stopPos = L.latLng(center.lat + latOffset, center.lng + lngOffset);
                let marker = L.marker(stopPos, {icon: iconBusGray}).addTo(map);
                allStopsData.push({ id: i, latLng: stopPos, marker: marker });
            }
        }

        function findNearestStop(targetLatLng) {
            let nearest = null;
            let minDist = Infinity;
            allStopsData.forEach(stop => {
                let dist = targetLatLng.distanceTo(stop.latLng);
                if (dist < minDist) { minDist = dist; nearest = stop; }
            });
            return nearest;
        }

        function clearRoutes() {
            routeControls.forEach(rc => map.removeControl(rc));
            routeControls = [];
            if (destinationMarker) map.removeLayer(destinationMarker);
            allStopsData.forEach(stop => {
                stop.marker.setIcon(iconBusGray);
                stop.marker.setZIndexOffset(0); 
            });
        }
        
        function clearSearchResults() {
            searchStopMarkers.clearLayers();
            searchRouteLines.clearLayers();
            clearRoutes(); 
        }

        function drawStopsAndRoutes(data) {
            clearSearchResults(); 

            if (data.stops) {
                data.stops.forEach(stop => {
                    const latlng = L.latLng(stop.latitude, stop.longitude);
                    L.marker(latlng)
                        .addTo(searchStopMarkers)
                        .bindPopup(`<b>${stop.stop_name}</b> (ID: ${stop.stop_id})`);
                });
            } ¬†

            if (data.routes) {
                data.routes.forEach(route => {
                    if (route.coordinates) {
                        const polyline = route.coordinates.map(c => [c.latitude, c.longitude]);
                        L.polyline(polyline, {
                            color: 'blue',
                            weight: 5,
                            opacity: 0.7
                        }).addTo(searchRouteLines)
                          .bindPopup(`Route ${route.route_id} (Trip ${route.trip_id})`);
                    } 
                });
            }
        
            if (searchStopMarkers.getLayers().length > 0 || searchRouteLines.getLayers().length > 0) {
                const bounds = searchStopMarkers.getBounds().isValid() 
                    ? searchStopMarkers.getBounds() : searchRouteLines.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, {padding: [50, 50]});
                }
            }
        }

        // Function to display the search suggestions in the dropdown
        function displaySuggestions(suggestions) {
            const dropdown = document.getElementById('search-results-dropdown');
            dropdown.innerHTML = ''; 

            if (suggestions.length === 0) return;

            suggestions.forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-suggestion-item';
                div.textContent = item.stop_name || item.display_name;
                
                div.addEventListener('click', () => {
                    document.getElementById('search-input').value = item.stop_name || item.display_name;
                    searchStopsAndAddresses(item.stop_name || item.display_name); 
                    // Hide dropdown immediately after selection
                    document.getElementById('search-results-dropdown').innerHTML = ''; 
                });

                dropdown.appendChild(div);
            });
        }
        
        function searchGeocodeFallback(query) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&limit=1`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const firstResult = data[0];
                        const lat = parseFloat(firstResult.lat);
                        const lon = parseFloat(firstResult.lon);
                        map.setView([lat, lon], 16);
                        L.marker([lat, lon]).addTo(searchStopMarkers).bindPopup(`General Location: ${firstResult.display_name}`).openPopup();
                    } else {
                        alert(`No general address found for "${query}".`);
                    }
                })
                .catch(error => console.error("Geocoding fallback failed:", error));
        }


        // --- 6. CLICK & LOGIC ---
        map.on('click', function(e) {
            if (!userLatLng || allStopsData.length === 0) return;

            clearRoutes(); 

            var destLatLng = e.latlng;
            destinationMarker = L.marker(destLatLng).addTo(map).bindPopup("<b>Destination</b>").openPopup();
            // ... rest of routing logic ...
            var distDirect = userLatLng.distanceTo(destLatLng);
            var startStop = findNearestStop(userLatLng);
            var endStop = findNearestStop(destLatLng);
            if (!startStop) return;
            var distToFirstStop = userLatLng.distanceTo(startStop.latLng);

            // Decision: Walk or Bus?
            if (distDirect < distToFirstStop || distDirect < 800) {
                createRoute(userLatLng, destLatLng, 
                    [{color: 'purple', opacity: 0.8, weight: 5, dashArray: '5, 10', lineCap: 'round'}], 'walking');
            } else {
                startStop.marker.setIcon(iconBusRed);
                startStop.marker.setZIndexOffset(1000); 
                endStop.marker.setIcon(iconBusRed);
                endStop.marker.setZIndexOffset(1000);
                createRoute(userLatLng, startStop.latLng, [{color: 'purple', opacity: 0.8, weight: 5, dashArray: '5, 10', lineCap: 'round'}], 'walking');
                if (startStop.id !== endStop.id) {
                    createRoute(startStop.latLng, endStop.latLng, [{color: 'green', opacity: 0.8, weight: 7}], 'driving');
                }
                createRoute(endStop.latLng, destLatLng, [{color: 'purple', opacity: 0.8, weight: 5, dashArray: '5, 10', lineCap: 'round'}], 'walking');
            }
            
            var bounds = L.latLngBounds([userLatLng, destLatLng]);
            map.fitBounds(bounds, {padding: [50, 50]});
        });

        function createRoute(start, end, styleStyles, mode) {
            var control = L.Routing.control({
                waypoints: [start, end],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: mode }),
                routeWhileDragging: false,
                addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: false, 
                show: false, createMarker: function() { return null; }, 
                lineOptions: { styles: styleStyles }
            }).addTo(map);
            routeControls.push(control);
        }
        
        // --- 7. SEARCH & API COMMUNICATION ---
        async function searchStopsAndAddresses(query) {
            if (query.length < 3) { alert("Please enter at least 3 characters to search."); return; }
            clearSearchResults();

            const requestData = { type: "SearchRequest", payload: { query: query } };
            console.log("üì° Sending search request to backend:", requestData);
            
            const API_URL = "http://localhost:5000/api/search"; 

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const result = await response.json();
                
                if (result.payload && (result.payload.stops.length > 0 || result.payload.routes.length > 0)) {
                    drawStopsAndRoutes(result.payload);
                } else {
                    searchGeocodeFallback(query); 
                }
            } catch (error) {
                console.error("Search API failed. Check if your Python backend is running:", error);
                searchGeocodeFallback(query); 
            }
        }

        // --- 8. EVENT LISTENERS ---

        // NEW: Live Search Input Listener (moved inside script block)
        document.getElementById('search-input').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            if (query.length > 2) {
                // --- SIMULATED DATA (REPLACE WITH REAL API CALL LATER) ---
                const mockSuggestions = [
                    { stop_name: "Central Station West", stop_id: "123" },
                    { stop_name: "Central Station East", stop_id: "456" },
                    { stop_name: "Market Square Station", stop_id: "789" },
                ].filter(s => s.stop_name.toLowerCase().includes(query.toLowerCase()));
                displaySuggestions(mockSuggestions);
                // --- END SIMULATED DATA ---
            } else {
                document.getElementById('search-results-dropdown').innerHTML = '';
            }
        });

        // Clear dropdown when input loses focus (user clicks away)
        document.getElementById('search-input').addEventListener('blur', function() {
            setTimeout(() => {
                document.getElementById('search-results-dropdown').innerHTML = '';
            }, 200);
        });

        // Event listener for the Search button
        document.getElementById('search-btn').addEventListener('click', function() {
            const query = document.getElementById('search-input').value.trim();
            searchStopsAndAddresses(query);
        });
        
        // Event listener for Enter key in the search bar
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                searchStopsAndAddresses(query);
            }
        });

        // Event listener for the Locate Me button
        document.getElementById('locate-btn').addEventListener('click', function() {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
                    map.setView(userLatLng, 15);
                    if (userMarker) {
                        userMarker.setLatLng(userLatLng);
                    } else {
                        userMarker = createUserMarker(userLatLng).addTo(map).bindPopup("<b>You</b>").openPopup();
                    }
                }, 
                function() { alert("Location could not be retrieved."); }, 
                { enableHighAccuracy: true }
            );
        });
    </script>
</body>
</html>