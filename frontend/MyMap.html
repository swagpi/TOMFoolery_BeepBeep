<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Smart Efficiency Map - Beep Beep</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        /* --- üé® PALETTE (Tropical Jade) --- */
        :root {
            --coral: #FCA47C;
            --sun: #F9D779;
            --aqua: #23CED9;
            --jade: #A1CCA6;
            --teal: #097C87;
            --dark-teal: #054A52;
            --bg-gray: #f3f4f6;
        }

        /* --- FONT FACE --- */
        @font-face {
            font-family: 'ZTNature-Medium';
            /* Ensure this file exists in your frontend folder, or it will fallback */
            src: url('ZTNature-Medium.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* üñº FRAME SETUP */
        body {
            margin: 0;
            padding: 0;
            font-family: 'ZTNature-Medium', system-ui, -apple-system, sans-serif;
            background: var(--bg-gray);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Main Container Card */
        .map-card {
            overflow: hidden;
            position: relative;
            width: min(1400px, 98vw);
            height: min(820px, 95vh);
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
            padding: 8px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Inner Map Container */
        .map-inner {
            position: relative;
            flex: 1;
            border-radius: 10px;
            overflow: hidden;
        }

        #map { 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
        }
        
        /* Hide default OSRM text instructions box */
        .leaflet-routing-container { display: none; }

        /* --- UI OVERLAYS --- */
        
        /* 1. Brand Badge */
        .brand-badge {
            position: absolute; top: 20px; right: 26px; z-index: 9999;
            background: var(--teal); color: white;
            padding: 10px 22px; border-radius: 999px;
            border: 4px solid white;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.22);
            font-size: 17px; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.1em; display: inline-flex; align-items: center; gap: 10px;
        }
        .brand-badge-dot { width: 14px; height: 14px; border-radius: 999px; background: var(--sun); }

        /* 2. Search Toolbar */
        .map-toolbar-container {
            position: absolute; top: 20px; left: 20px; z-index: 9999; width: 320px;
        }
        .map-toolbar {
            display: flex; gap: 8px; padding: 8px;
            background-color: var(--jade);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        #search-input {
            flex: 1; padding: 8px 12px; border: 1px solid #ccc; background: white;
            border-radius: 6px; font-size: 16px; outline: none;
            font-family: inherit;
        }
        #search-btn {
            width: 40px; height: 40px; background-color: #f0f0f0; color: #333;
            border: 1px solid #ccc; border-radius: 15px; cursor: pointer; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
        }

        /* 3. Search Dropdown */
        #search-results-dropdown {
            margin-top: 5px; width: 100%; background: white;
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            max-height: 300px; overflow-y: auto; display: none; 
        }
        .search-suggestion-item {
            padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee;
            font-size: 14px; color: #333;
        }
        .search-suggestion-item:last-child { border-bottom: none; }
        .search-suggestion-item:hover { background-color: #f0f0f0; }

        /* 4. Zoom & Locate Controls */
        .custom-zoom-controls {
            position: absolute; bottom: 30px; right: 20px; z-index: 9999; 
            display: flex; flex-direction: column; gap: 10px; 
        }
        .zoom-btn {
            width: 45px; height: 45px; background-color: white;
            border: 2px solid #ccc; border-radius: 50%;
            font-size: 24px; font-weight: bold; color: #333; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s, transform 0.1s;
        }
        .zoom-btn:active { background-color: #f0f0f0; transform: scale(0.95); }
        #locate-btn { background-color: var(--teal); color: white; border: none; }
        #locate-btn:hover { background-color: #1e88e5; }

        /* --- SIDEBAR (LEFT PANEL - NEW FEATURE) --- */
        .sidebar {
            position: absolute;
            top: 80px; /* Below toolbar */
            left: 20px; 
            bottom: 40px; /* Above bottom edge */
            width: 320px;
            background: white;
            z-index: 2000; /* Above map controls */
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateX(-360px); /* Hidden by default */
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            background: var(--teal);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--sun);
        }
        .sidebar-title { font-weight: bold; font-size: 18px; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .close-btn { 
            background: none; border: none; color: white; font-size: 28px; cursor: pointer; line-height: 1; padding: 0 5px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto; /* Scrollable */
            padding: 10px;
            background: #f9f9f9;
        }

        /* Trip Cards inside Sidebar */
        .trip-card {
            background: white;
            border-left: 5px solid var(--coral);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        .trip-card:hover { background-color: #fdfdfd; }
        .trip-info { display: flex; flex-direction: column; gap: 2px; }
        .trip-route { font-weight: bold; color: var(--dark-teal); font-size: 16px; }
        .trip-dest { font-size: 12px; color: #666; }
        .trip-time { 
            font-weight: bold; font-size: 16px; color: var(--teal); 
            background: var(--bg-gray); padding: 6px 12px; border-radius: 8px;
        }
        .no-data { text-align: center; color: #999; margin-top: 20px; font-size: 15px; }


        /* --- MARKER STYLES --- */
        .custom-bus-icon {
            border-radius: 50%; border: 2px solid white;  
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); box-sizing: border-box;
        }
        .bus-active { background-color: var(--coral); }
        .bus-passive { background-color: var(--sun); }

        /* --- POPUP STYLES --- */
        .leaflet-popup-content-wrapper {
            border-radius: 12px; padding: 0;
            box-shadow: 0 4px 14px rgba(0,0,0,0.1);
        }
        .leaflet-popup-content {
            margin: 10px 14px;
            font-size: 14px; color: #333; text-align: center; font-weight: bold;
        }
        .leaflet-popup-tip-container { display: none; } 
        a.leaflet-popup-close-button { display: none; } 

    </style>
</head>
<body>

    <div class="map-card">
        
        <div class="brand-badge">
            <span class="brand-badge-dot"></span>
            <span>beep beep</span>
        </div>

        <div class="map-inner">
            
            <div class="map-toolbar-container">
                <div class="map-toolbar">
                    <input type="text" id="search-input" placeholder="Search for a stop..." />
                    <button id="search-btn" title="Search">üîç</button>
                </div>
                <div id="search-results-dropdown"></div>
            </div>

            <div id="info-sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title" id="sidebar-stop-name">Stop Info</h2>
                    <button class="close-btn" onclick="closeSidebar()">√ó</button>
                </div>
                <div class="sidebar-content" id="sidebar-list">
                    <div class="no-data">Select a stop to see trips</div>
                </div>
            </div>

            <div id="map"></div>

            <div class="custom-zoom-controls">
                <button id="locate-btn" class="zoom-btn" title="Locate Me">üìç</button>
                <button class="zoom-btn" onclick="map.zoomIn()">+</button>
                <button class="zoom-btn" onclick="map.zoomOut()">-</button>
            </div>
        </div>
    </div>
<script>
        // --- CONFIGURATION ---
        const USE_MOCK_DATA = false; // ‚ö†Ô∏è BACKEND KAPALIYKEN BUNU TRUE YAP
        const BACKEND_URL = "http://localhost:8000"; 
        const SNAP_RADIUS_METERS = 50; 
        const ABSOLUTE_MIN_WALK = 200; 

        // --- 1. ICONS ---
        var iconBusRed = L.divIcon({ className: 'custom-bus-icon bus-active', html: '', iconSize: [20, 20], iconAnchor: [10, 10] });
        var iconBusGray = L.divIcon({ className: 'custom-bus-icon bus-passive', html: '', iconSize: [20, 20], iconAnchor: [10, 10] });
        
        var iconDestination = L.divIcon({ 
            className: '', 
            html: `
            <svg width="36" height="48" viewBox="0 0 30 42" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.3));">
                <path d="M15 0C6.71573 0 0 6.71573 0 15C0 26.25 15 42 15 42C15 42 30 26.25 30 15C30 6.71573 23.2843 0 15 0Z" fill="#097C87" stroke="white" stroke-width="2"/>
                <circle cx="15" cy="15" r="4" fill="white"/>
            </svg>
            `, 
            iconSize: [36, 48], 
            iconAnchor: [18, 48], 
            popupAnchor: [0, -50]
        });

        function createUserMarker(latlng) {
            return L.circleMarker(latlng, { radius: 9, fillColor: "#2196F3", color: "#FFF", weight: 3, fillOpacity: 1 });
        }

        // --- 2. MAP SETUP ---
        var map = L.map('map', { dragging: true, tap: true, zoomControl: false }).setView([50.99955, 8.00122], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{ 
            attribution: '&copy; OpenStreetMap contributors', noWrap: true 
        }).addTo(map);

        var userLatLng = null;
        var allStopsData = []; 
        var routeControls = []; 
        var destinationMarker = null;
        var userMarker = null;
        
        var stopsLayerGroup = L.layerGroup().addTo(map);
        var searchStopMarkers = L.layerGroup().addTo(map);

        // --- 3. GET LOCATION ---
        navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true });

        function success(position) {
            userLatLng = L.latLng(position.coords.latitude, position.coords.longitude); 
            map.setView(userLatLng, 15);
            
            if(userMarker) map.removeLayer(userMarker);
            userMarker = createUserMarker(userLatLng).addTo(map).bindPopup("<b>You</b>");
            fetchMapDataFromBackend();
        }

        function error() { 
            console.log("Location denied. Defaulting to center."); 
            var defaultLoc = L.latLng(51.0, 8.0);
            userLatLng = defaultLoc;
            map.setView(defaultLoc, 14);
            if(userMarker) map.removeLayer(userMarker);
            userMarker = createUserMarker(userLatLng).addTo(map).bindPopup("<b>You</b>");
            fetchMapDataFromBackend();
        }

        // --- 4. SIDEBAR LOGIC ---
        function closeSidebar() {
            document.getElementById('info-sidebar').classList.remove('open');
        }

        function formatTime(hhmmss) {
            if(!hhmmss || hhmmss.length < 4) return hhmmss;
            return hhmmss.substring(0,2) + ":" + hhmmss.substring(2,4);
        }

        async function openStopSidebar(stopId, stopName) {
            const sidebar = document.getElementById('info-sidebar');
            const titleEl = document.getElementById('sidebar-stop-name');
            const listEl = document.getElementById('sidebar-list');

            // UI Setup
            titleEl.textContent = stopName;
            listEl.innerHTML = '<div class="no-data">Loading trips...</div>';
            sidebar.classList.add('open');

            // --- MOCK DATA LOGIC (BACKEND KAPALIYKEN) ---
            if (USE_MOCK_DATA) {
                console.log(`Generating sorted mock trips for: ${stopName}`);
                
                setTimeout(() => {
                    listEl.innerHTML = ''; 
                    
                    // 1. Verileri olu≈ütur (Hen√ºz ekrana basma)
                    let mockTrips = [];
                    const now = new Date();
                    const currentHour = now.getHours();
                    const currentMin = now.getMinutes();

                    // 5-6 tane rastgele sefer √ºret
                    for(let i=0; i<6; i++) {
                        const randomRoute = Math.floor(Math.random() * 100) + 10;
                        
                        // ≈ûu anki zamana rastgele 0-60 dakika ekle
                        const addedMins = Math.floor(Math.random() * 60);
                        let tripTimeMin = currentMin + addedMins;
                        let tripTimeHour = currentHour;
                        
                        if (tripTimeMin >= 60) {
                            tripTimeHour += 1;
                            tripTimeMin -= 60;
                        }

                        // Sƒ±ralama yapabilmek i√ßin sayƒ±sal deƒüer (dakika cinsinden)
                        const totalMinutes = tripTimeHour * 60 + tripTimeMin;
                        
                        // Ekranda g√∂r√ºnecek format (√ñrn: 14:05)
                        const timeString = `${tripTimeHour}:${tripTimeMin < 10 ? '0'+tripTimeMin : tripTimeMin}`;

                        mockTrips.push({
                            route: randomRoute,
                            dest: "City Center",
                            displayTime: timeString,
                            sortValue: totalMinutes // Sƒ±ralama anahtarƒ±
                        });
                    }

                    // 2. Lƒ∞STEYƒ∞ SIRALA (K√º√ß√ºkten B√ºy√ºƒüe -> En erken en √ºstte)
                    mockTrips.sort((a, b) => a.sortValue - b.sortValue);

                    // 3. Sƒ±ralƒ± listeyi ekrana bas
                    mockTrips.forEach(trip => {
                        const item = document.createElement('div');
                        item.className = 'trip-card';
                        item.innerHTML = `
                            <div class="trip-info">
                                <span class="trip-route">Bus ${trip.route}</span>
                                <span class="trip-dest">Direction: ${trip.dest}</span>
                            </div>
                            <div class="trip-time">${trip.displayTime}</div>
                        `;
                        listEl.appendChild(item);
                    });

                }, 300); 
                return;
            }
            // --- END MOCK DATA ---

            // --- REAL BACKEND DATA ---
            try {
                const response = await fetch(`${BACKEND_URL}/station_info?stop_id=${stopId}`);
                const data = await response.json();

                listEl.innerHTML = ''; 

                if (data.next_trips && data.next_trips.length > 0) {
                    
                    // BURAYA DA SIRALAMA EKLENDƒ∞ (GARANTƒ∞ OLSUN Dƒ∞YE)
                    data.next_trips.sort((a, b) => {
                        const tA = parseInt(a.estimated_arrival || a.arrival_time);
                        const tB = parseInt(b.estimated_arrival || b.arrival_time);
                        return tA - tB; // K√º√ß√ºk sayƒ± (erken saat) yukarƒ±
                    });

                    data.next_trips.forEach(trip => {
                        const timeStr = trip.estimated_arrival || trip.arrival_time; 
                        const displayTime = formatTime(timeStr);
                        
                        const item = document.createElement('div');
                        item.className = 'trip-card';
                        item.innerHTML = `
                            <div class="trip-info">
                                <span class="trip-route">Route ${trip.route_id}</span>
                                <span class="trip-dest">Trip ID: ${trip.trip_id}</span>
                            </div>
                            <div class="trip-time">${displayTime}</div>
                        `;
                        listEl.appendChild(item);
                    });
                } else {
                    listEl.innerHTML = '<div class="no-data">No upcoming trips found.</div>';
                }

            } catch (e) {
                console.error(e);
                listEl.innerHTML = '<div class="no-data">Error loading data.<br>Check backend connection.</div>';
            }
        }

        // --- 5. BACKEND INTERACTION ---
        map.on('moveend', function() { 
            fetchMapDataFromBackend(); 
        });

        async function fetchMapDataFromBackend() {
            
            // --- MOCK DATA LOGIC FOR MAP STOPS ---
            if (USE_MOCK_DATA) {
                const center = map.getCenter();
                console.log("‚ö†Ô∏è Backend offline. Generating 2 random stops near center:", center);
                
                // Create 2 random stops near the current view center
                const mockStops = [
                    {
                        stop_id: "mock_1",
                        stop_name: "Random Stop A",
                        latitude: center.lat + 0.002, // Slightly North
                        longitude: center.lng + 0.002 // Slightly East
                    },
                    {
                        stop_id: "mock_2",
                        stop_name: "Random Stop B",
                        latitude: center.lat - 0.002, // Slightly South
                        longitude: center.lng - 0.002 // Slightly West
                    }
                ];
                
                updateMapWithBackendData(mockStops);
                return; // Stop here, don't fetch
            }
            // --- END MOCK DATA ---

            const bounds = map.getBounds();
            const requestBody = {
                north: bounds.getNorth(),
                south: bounds.getSouth(),
                east: bounds.getEast(),
                west: bounds.getWest(),
                buffer_meters: 100, 
                max_stops: 150
            };

            try {
                const response = await fetch(`${BACKEND_URL}/map_data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();
                
                if (data.type === "MapDataResponse" && data.payload && data.payload.stops) {
                    updateMapWithBackendData(data.payload.stops);
                }

            } catch (error) {
                console.error("Error fetching map data:", error);
            }
        }

        function updateMapWithBackendData(stopsList) {
            stopsLayerGroup.clearLayers();
            allStopsData = []; 

            stopsList.forEach(stopData => {
                let stopPos = L.latLng(stopData.latitude, stopData.longitude);
                let marker = L.marker(stopPos, {icon: iconBusGray});
                
                marker.bindPopup(stopData.stop_name, { offset: [0, -10], autoPan: true });

                // CLICK EVENT: Route + Sidebar
                marker.on('click', function(e) { 
                    L.DomEvent.stopPropagation(e); 
                    processJourney(e.latlng, true, stopData.stop_id); 
                    openStopSidebar(stopData.stop_id, stopData.stop_name);
                });
                
                stopsLayerGroup.addLayer(marker);
                allStopsData.push({ 
                    stop_id: stopData.stop_id, 
                    stop_name: stopData.stop_name, 
                    latLng: stopPos, 
                    marker: marker 
                });
            });
            console.log(`Updated map with ${stopsList.length} stops.`);
        }

        function findNearestStop(targetLatLng) {
            let nearest = null;
            let minDist = Infinity;
            allStopsData.forEach(stop => {
                let dist = targetLatLng.distanceTo(stop.latLng);
                if (dist < minDist) { minDist = dist; nearest = stop; }
            });
            return { stop: nearest, distance: minDist };
        }

        // --- 6. CLEANUP & ROUTING ---
        function clearRoutes() {
            map.closePopup(); 
            routeControls.forEach(rc => map.removeControl(rc));
            routeControls = [];
            if (destinationMarker) map.removeLayer(destinationMarker);
            
            allStopsData.forEach(stop => { 
                stop.marker.setIcon(iconBusGray); 
                stop.marker.setZIndexOffset(0); 
            });
        }
        
        function clearSearchResults() {
            searchStopMarkers.clearLayers();
            document.getElementById('search-results-dropdown').style.display = 'none';
        }

        map.on('click', function(e) {
            var clickedLoc = e.latlng;
            var finalDestination = clickedLoc;
            var snapped = false;
            var snappedId = null;
            
            var result = findNearestStop(clickedLoc);
            if (result.stop && result.distance < SNAP_RADIUS_METERS) {
                finalDestination = result.stop.latLng;
                snapped = true;
                snappedId = result.stop.stop_id;
                openStopSidebar(snappedId, result.stop.stop_name);
            }
            processJourney(finalDestination, snapped, snappedId);
        });

        function processJourney(destLatLng, isBusStop, stopId) {
            if (!userLatLng) { alert("Waiting for user location..."); return; }
            
            clearRoutes(); 
            clearSearchResults();

            var distDirect = userLatLng.distanceTo(destLatLng);
            var startData = findNearestStop(userLatLng);
            
            var endStop = null;
            if (isBusStop && stopId) {
                endStop = allStopsData.find(s => s.stop_id === stopId);
            } else {
                let nearestEnd = findNearestStop(destLatLng);
                if(nearestEnd.stop) endStop = nearestEnd.stop;
            }
            var startStop = startData.stop;
            
            if (isBusStop && endStop) {
                endStop.marker.openPopup();
            } else {
                destinationMarker = L.marker(destLatLng, {icon: iconDestination}).addTo(map);
                destinationMarker.bindPopup("Destination", { offset: [0, -45] }).openPopup();
            }

            var useBus = false;
            if (startStop && endStop && startStop.stop_id !== endStop.stop_id) {
                var distToStart = userLatLng.distanceTo(startStop.latLng);
                var distFromEnd = endStop.latLng.distanceTo(destLatLng);
                var totalBusOverheadWalk = distToStart + distFromEnd;
                
                if (distDirect > ABSOLUTE_MIN_WALK && distDirect > totalBusOverheadWalk) {
                    useBus = true;
                }
            }

            var walkStyles = [ 
                { color: '#6E8F72', opacity: 1, weight: 7 }, 
                { color: '#A1CCA6', opacity: 1, weight: 4, lineCap: 'round', dashArray: '1, 10' } 
            ];
            var busStyles = [ 
                { color: '#054A52', opacity: 0.8, weight: 8 }, 
                { color: '#23CED9', opacity: 1, weight: 4 } 
            ];

            if (!useBus) {
                console.log("Decision: Walk");
                createRoute(userLatLng, destLatLng, walkStyles, 'walking');
            } else {
                console.log("Decision: Bus");
                startStop.marker.setIcon(iconBusRed);
                startStop.marker.setZIndexOffset(1000);
                endStop.marker.setIcon(iconBusRed);
                endStop.marker.setZIndexOffset(1000);

                createRoute(userLatLng, startStop.latLng, walkStyles, 'walking');
                createRoute(startStop.latLng, endStop.latLng, busStyles, 'driving'); 
                
                if (!isBusStop) {
                    createRoute(endStop.latLng, destLatLng, walkStyles, 'walking');
                }
            }
            
            var bounds = L.latLngBounds([userLatLng, destLatLng]);
            map.fitBounds(bounds, {padding: [80, 80]}); 
        }

        function createRoute(start, end, styleStyles, mode) {
            var control = L.Routing.control({
                waypoints: [start, end],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: mode }),
                routeWhileDragging: false, addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: false, 
                show: false, createMarker: function() { return null; }, 
                lineOptions: { styles: styleStyles } 
            }).addTo(map);
            routeControls.push(control);
        }

        // --- 7. SEARCH FEATURE ---
        const searchInput = document.getElementById('search-input');
        const searchDropdown = document.getElementById('search-results-dropdown');

        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim().toLowerCase();
            searchDropdown.innerHTML = '';
            
            if (query.length > 2) {
                const matches = allStopsData.filter(s => s.stop_name.toLowerCase().includes(query));
                if (matches.length > 0) {
                    searchDropdown.style.display = 'block';
                    matches.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'search-suggestion-item';
                        div.textContent = item.stop_name;
                        div.onclick = () => {
                            selectSearchResult(item);
                        };
                        searchDropdown.appendChild(div);
                    });
                } else {
                    searchDropdown.style.display = 'none';
                }
            } else {
                searchDropdown.style.display = 'none';
            }
        });

        function selectSearchResult(item) {
            searchInput.value = item.stop_name;
            searchDropdown.style.display = 'none';
            
            map.setView(item.latLng, 16);
            item.marker.openPopup();
            processJourney(item.latLng, true, item.stop_id);
            openStopSidebar(item.stop_id, item.stop_name);
        }

        // --- 8. LOCATE ME ---
        document.getElementById('locate-btn').addEventListener('click', function() {
            navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true });
        });

    </script>
</body>
</html>