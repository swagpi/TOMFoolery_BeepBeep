<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Smart Efficiency Map - Beep Beep</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        /* --- üé® PALETTE --- */
        :root {
            --coral: #FCA47C; --sun: #F9D779; --aqua: #23CED9;
            --jade: #A1CCA6; --teal: #097C87; --dark-teal: #054A52;
            --purple: #9B59B6; /* Live Bus Color */
            --bg-gray: #f3f4f6;
        }

        @font-face {
            font-family: 'ZTNature-Medium';
            src: url('ZTNature-Medium.ttf') format('truetype');
            font-weight: normal; font-style: normal;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'ZTNature-Medium', sans-serif;
            background: var(--bg-gray);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh;
        }

        .map-card {
            position: relative; width: min(1400px, 98vw); height: min(820px, 95vh);
            background: #ffffff; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
            padding: 8px; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 6px;
        }

        .map-inner { position: relative; flex: 1; border-radius: 10px; overflow: hidden; }
        #map { width: 100%; height: 100%; z-index: 1; }
        
        .map-disabled { cursor: not-allowed !important; }
        .leaflet-routing-container { display: none; }

        /* --- NEW LOGO STYLE --- */
        .brand-logo {
            position: absolute; top: 20px; right: 26px; z-index: 9999;
            width: 180px; height: auto;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.15));
        }

        /* Controls */
        .map-toolbar-container { position: absolute; top: 20px; left: 20px; z-index: 9999; width: 340px; }
        
        .map-toolbar {
            display: flex; gap: 8px; padding: 8px;
            background-color: #027361; 
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        #search-input { flex: 1; padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; outline: none; }
        #search-btn { width: 45px; cursor: pointer; border-radius: 10px; border: 1px solid #ccc; }

        #search-results-dropdown {
            margin-top: 5px; width: 100%; background: white;
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            max-height: 350px; overflow-y: auto; display: none; 
        }
        .search-suggestion-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-suggestion-item:hover { background-color: #f0f0f0; }

        .custom-zoom-controls {
            position: absolute; bottom: 30px; right: 20px; z-index: 9999; 
            display: flex; flex-direction: column; gap: 10px; 
        }
        .zoom-btn {
            width: 45px; height: 45px; background-color: white;
            border: 2px solid #ccc; border-radius: 50%;
            font-size: 24px; font-weight: bold; color: #333; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
        }
        .zoom-btn:active { background-color: #f0f0f0; transform: scale(0.95); }
        
        #toggle-label-btn.disabled-mode { background-color: #ffdddd; color: #c0392b; border-color: #e74c3c; }

        /* Sidebar */
        .sidebar {
            position: absolute; top: 80px; left: 20px; bottom: 40px; 
            width: 340px; background: white; z-index: 2000; 
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateX(-380px); transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { background: var(--teal); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--sun); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; }
        
        /* TRIP CARD UPDATED STYLE */
        .trip-card { 
            background: white; border-left: 5px solid var(--coral); border-radius: 6px; 
            padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background-color 0.2s;
        }
        .trip-card:hover { background-color: #e0f7fa; border-left-color: var(--teal); }

        .trip-info { display: flex; flex-direction: column; gap: 4px; }
        
        /* Route name (e.g., 12A) bigger */
        .trip-route { font-weight: 800; color: var(--dark-teal); font-size: 18px; }
        
        /* Destination (Last Stop) smaller */
        .trip-dest { 
            font-size: 13px; color: #555; font-weight: 500; 
            display: flex; align-items: center; gap: 4px;
        }
        .trip-dest::before { content: '‚ûî'; font-size: 10px; color: #888; }

        .trip-time { font-weight: bold; color: var(--teal); background: var(--bg-gray); padding: 6px 12px; border-radius: 8px; font-size: 16px; }
        .no-data { text-align: center; color: #999; margin-top: 20px; }

        /* Custom Styles */
        .custom-bus-icon { border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); box-sizing: border-box; }
        .bus-active { background-color: var(--coral); }
        .bus-passive { background-color: var(--sun); }
        .bus-route-stop-yellow { background-color: var(--sun); border: 2px solid #fff; z-index: 1000 !important; }
        
        /* Live Bus Icon */
        .bus-live {
            background-color: var(--purple);
            border: 2px solid white;
            box-shadow: 0 0 8px var(--purple);
            z-index: 2000 !important;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 12px;
        }

        .stop-name-label {
            background-color: transparent; border: none; box-shadow: none;
            font-size: 11px; font-weight: bold; color: #333;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
        }

        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
        .leaflet-popup-content { margin: 10px 14px; font-size: 14px; color: #333; text-align: center; font-weight: bold; }
        .leaflet-popup-tip-container { display: none; } 
        a.leaflet-popup-close-button { display: none; } 
        
        /* HIDE LOGIC */
        .hide-routes .destination-pin { display: none !important; }
        .hide-routes .leaflet-routePane-pane { display: none !important; }
        .hide-routes .bus-live { display: none !important; }

    </style>
</head>
<body>

    <div class="map-card">
        <img src="logo.png" alt="Beep Beep Logo" class="brand-logo">
        <div class="map-inner" id="map-wrapper">
            
            <div class="map-toolbar-container">
                <div class="map-toolbar">
                    <input type="text" id="search-input" placeholder="Search stop or address..." />
                    <button id="search-btn">üîç</button>
                </div>
                <div id="search-results-dropdown"></div>
            </div>

            <div id="info-sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title" id="sidebar-stop-name">Stop Info</h2>
                    <button class="close-btn" onclick="closeSidebar()">√ó</button>
                </div>
                <div class="sidebar-content" id="sidebar-list"></div>
            </div>

            <div id="map"></div>

            <div class="custom-zoom-controls">
                <button id="toggle-label-btn" class="zoom-btn" title="Toggle Pathfinding">üëÅÔ∏è</button>
                <button id="locate-btn" class="zoom-btn" title="Locate Me">üìç</button>
                <button class="zoom-btn" onclick="map.zoomIn()">+</button>
                <button class="zoom-btn" onclick="map.zoomOut()">-</button>
            </div>
        </div>
    </div>

    <script>
        const USE_MOCK_DATA = false; 
        const BACKEND_URL = "http://localhost:8000"; 
        const NOMINATIM_URL = "https://nominatim.openstreetmap.org/search"; 
        const SNAP_RADIUS_METERS = 150; 
        const ABSOLUTE_MIN_WALK = 200; 

        // --- STATE ---
        let isPathfindingActive = true; 
        let activeTripPolyline = null; 
        
        // --- LIVE TRACKING STATE ---
        let liveTrackingInterval = null;
        let liveBusLayerGroup = null;

        // --- ICONS ---
        var iconBusRed = L.divIcon({ className: 'custom-bus-icon bus-active', html: '', iconSize: [20, 20], iconAnchor: [10, 10] });
        var iconBusGray = L.divIcon({ className: 'custom-bus-icon bus-passive', html: '', iconSize: [20, 20], iconAnchor: [10, 10] });
        var iconBusYellow = L.divIcon({ className: 'custom-bus-icon bus-route-stop-yellow', html: '', iconSize: [16, 16], iconAnchor: [8, 8] });
        
        var iconLiveBus = L.divIcon({ 
            className: 'custom-bus-icon bus-live', 
            html: 'üöå', 
            iconSize: [26, 26], 
            iconAnchor: [13, 13] 
        });

        var iconDestination = L.divIcon({ 
            className: 'destination-pin', 
            html: `<svg width="36" height="48" viewBox="0 0 30 42" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.3));"><path d="M15 0C6.71573 0 0 6.71573 0 15C0 26.25 15 42 15 42C15 42 30 26.25 30 15C30 6.71573 23.2843 0 15 0Z" fill="#E74C3C" stroke="white" stroke-width="2"/><circle cx="15" cy="15" r="4" fill="white"/></svg>`, 
            iconSize: [36, 48], iconAnchor: [18, 48], popupAnchor: [0, -20] 
        });

        function createUserMarker(latlng) { return L.circleMarker(latlng, { radius: 9, fillColor: "#2196F3", color: "#FFF", weight: 3, fillOpacity: 1 }); }

        // --- MAP SETUP ---
        var map = L.map('map', { dragging: true, tap: true, zoomControl: false }).setView([50.99955, 8.00122], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{ attribution: '&copy; OpenStreetMap', noWrap: true }).addTo(map);

        // Custom Pane for Routes
        map.createPane('routePane');
        map.getPane('routePane').style.zIndex = 399;

        var userLatLng = null;
        var allStopsData = []; 
        var routeControls = []; 
        var destinationMarker = null;
        var userMarker = null;
        var stopsLayerGroup = L.layerGroup().addTo(map);
        var liveBusLayerGroup = L.layerGroup().addTo(map);

        navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true });

        function success(position) {
            userLatLng = L.latLng(position.coords.latitude, position.coords.longitude); 
            map.setView(userLatLng, 15);
            if(userMarker) map.removeLayer(userMarker);
            userMarker = createUserMarker(userLatLng).addTo(map).bindPopup("<b>You</b>");
            fetchMapDataFromBackend();
        }
        function error() { 
            var defaultLoc = L.latLng(51.0, 8.0); userLatLng = defaultLoc; map.setView(defaultLoc, 14);
            if(userMarker) map.removeLayer(userMarker); userMarker = createUserMarker(userLatLng).addTo(map).bindPopup("<b>You</b>");
            fetchMapDataFromBackend();
        }
        
        function closeSidebar() { 
            document.getElementById('info-sidebar').classList.remove('open'); 
        }
        
        function formatTime(t) { if(!t || t.length<4) return t; return t.substring(0,2)+":"+t.substring(2,4); }

        async function openStopSidebar(stopId, stopName) {
            const sidebar = document.getElementById('info-sidebar');
            const titleEl = document.getElementById('sidebar-stop-name');
            const listEl = document.getElementById('sidebar-list');
            titleEl.textContent = stopName; listEl.innerHTML = '<div class="no-data">Loading...</div>';
            sidebar.classList.add('open');
            try {
                const response = await fetch(`${BACKEND_URL}/station_info?stop_id=${stopId}`);
                const data = await response.json();
                listEl.innerHTML = ''; 
                if (data.next_trips && data.next_trips.length > 0) {
                    data.next_trips.sort((a, b) => parseInt(a.estimated_arrival||a.arrival_time) - parseInt(b.estimated_arrival||b.arrival_time));
                    data.next_trips.forEach(trip => {
                        const timeStr = trip.estimated_arrival || trip.arrival_time; 
                        
                        // --- USE THE NEW FIELDS HERE ---
                        const routeName = trip.display_route_name || trip.route_id;
                        const headsign = trip.display_headsign || trip.trip_id;

                        const item = document.createElement('div'); item.className = 'trip-card';
                        item.onclick = () => visualizeTrip(stopId, trip.trip_id); 
                        
                        item.innerHTML = `
                            <div class="trip-info">
                                <span class="trip-route">${routeName}</span>
                                <span class="trip-dest">${headsign}</span>
                            </div>
                            <div class="trip-time">${formatTime(timeStr)}</div>
                        `;
                        listEl.appendChild(item);
                    });
                } else { listEl.innerHTML = '<div class="no-data">No upcoming trips.</div>'; }
            } catch (e) { listEl.innerHTML = '<div class="no-data">Error loading data.</div>'; }
        }

        // --- VISUALIZE TRIP & START LIVE TRACKING ---
        async function visualizeTrip(stopId, tripId) {
            if (!isPathfindingActive) return; 

            try {
                const response = await fetch(`${BACKEND_URL}/routes_for_stop?stop_id=${stopId}`);
                const tripsData = await response.json();
                
                const targetTrip = tripsData.find(t => t.trip_id == tripId);
                
                if (!targetTrip || !targetTrip.full_route_stops) {
                    alert("Route path not found for this trip.");
                    return;
                }

                clearRoutes(); 
                stopsLayerGroup.clearLayers(); 
                liveBusLayerGroup.clearLayers(); 
                if(activeTripPolyline) { map.removeLayer(activeTripPolyline); activeTripPolyline = null; }

                const pathCoordinates = targetTrip.full_route_stops.map(s => [s.lat, s.lon]);
                
                activeTripPolyline = L.polyline(pathCoordinates, {
                    color: 'var(--jade)', 
                    weight: 6,
                    opacity: 0.9,
                    pane: 'routePane' 
                }).addTo(map);

                map.fitBounds(activeTripPolyline.getBounds(), {padding: [50, 50]});

                // Draw Stops
                targetTrip.full_route_stops.forEach(stop => {
                    let marker = L.marker([stop.lat, stop.lon], {icon: iconBusYellow});
                    marker.bindTooltip(stop.name, { permanent: true, direction: 'top', className: 'stop-name-label', offset: [0, -10] });
                    marker.bindPopup(`<b>${stop.name}</b><br>Seq: ${stop.sequence}`);
                    stopsLayerGroup.addLayer(marker);
                });

                // Draw live buses from 'last_known_stop' if available
                tripsData.forEach(t => {
                    if (t.last_known_stop && t.route_id === targetTrip.route_id) {
                        const stopInfo = targetTrip.full_route_stops.find(s => s.stop_id == t.last_known_stop);
                        if (stopInfo) {
                            let busMarker = L.marker([stopInfo.lat, stopInfo.lon], {icon: iconLiveBus});
                            busMarker.bindPopup(`<b>Bus ${t.route_id}</b><br>Trip: ${t.trip_id}<br>Last Stop: ${stopInfo.name}`);
                            liveBusLayerGroup.addLayer(busMarker);
                        }
                    }
                });

            } catch(e) {
                console.error("Error visualising trip:", e);
            }
        }

        map.on('moveend', function() { 
            if (!activeTripPolyline) {
                fetchMapDataFromBackend(); 
            }
        });

        async function fetchMapDataFromBackend() {
            if(USE_MOCK_DATA || !isPathfindingActive) return;
            if (activeTripPolyline) return; 

            const bounds = map.getBounds();
            const requestBody = {
                north: bounds.getNorth(), south: bounds.getSouth(), east: bounds.getEast(), west: bounds.getWest(),
                buffer_meters: 200, max_stops: 200
            };
            try {
                const response = await fetch(`${BACKEND_URL}/map_data`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                const data = await response.json();
                if (data.type === "MapDataResponse" && data.payload && data.payload.stops) { updateMapWithBackendData(data.payload.stops); }
            } catch (error) { console.error("Fetch error:", error); }
        }

        function updateMapWithBackendData(stopsList) {
            stopsLayerGroup.clearLayers(); allStopsData = []; 
            stopsList.forEach(stopData => {
                let stopPos = L.latLng(stopData.latitude, stopData.longitude);
                let marker = L.marker(stopPos, {icon: iconBusGray});
                marker.bindPopup(stopData.stop_name, { offset: [0, -10], autoPan: true });
                
                marker.on('click', function(e) { 
                    L.DomEvent.stopPropagation(e); 
                    openStopSidebar(stopData.stop_id, stopData.stop_name);
                    
                    if (isPathfindingActive) {
                        // If we are in "Trip View", clicking another stop should reset and calculate route
                        if (activeTripPolyline) {
                             if(activeTripPolyline) { map.removeLayer(activeTripPolyline); activeTripPolyline = null; }
                             liveBusLayerGroup.clearLayers(); 
                             fetchMapDataFromBackend(); 
                        }
                        processJourney(e.latlng, true, stopData.stop_id); 
                    } else {
                        clearRoutes();
                    }
                });
                
                stopsLayerGroup.addLayer(marker);
                allStopsData.push({ stop_id: stopData.stop_id, stop_name: stopData.stop_name, latLng: stopPos, marker: marker });
            });
        }

        function findNearestStop(targetLatLng) {
            let nearest = null; let minDist = Infinity;
            allStopsData.forEach(stop => { let dist = targetLatLng.distanceTo(stop.latLng); if (dist < minDist) { minDist = dist; nearest = stop; } });
            return { stop: nearest, distance: minDist };
        }

        function clearRoutes() {
            map.closePopup(); 
            routeControls.forEach(rc => map.removeControl(rc)); routeControls = [];
            if (destinationMarker) map.removeLayer(destinationMarker);
            
            if(activeTripPolyline) { map.removeLayer(activeTripPolyline); activeTripPolyline = null; }
            liveBusLayerGroup.clearLayers(); 
            
            allStopsData.forEach(stop => { stop.marker.setIcon(iconBusGray); stop.marker.setZIndexOffset(0); });
        }

        // --- MAP CLICK HANDLER ---
        map.on('click', function(e) {
            document.getElementById('search-results-dropdown').style.display = 'none';
            
            if (activeTripPolyline) {
                if(activeTripPolyline) { map.removeLayer(activeTripPolyline); activeTripPolyline = null; }
                liveBusLayerGroup.clearLayers();
                fetchMapDataFromBackend();
                closeSidebar();
                return;
            }

            if (!isPathfindingActive) return; 

            var result = findNearestStop(e.latlng);
            var isSnapped = (result.stop && result.distance < SNAP_RADIUS_METERS);

            if (isSnapped) {
                openStopSidebar(result.stop.stop_id, result.stop.stop_name);
                if(isPathfindingActive) processJourney(result.stop.latLng, true, result.stop.stop_id);
                else clearRoutes();
            } else {
                if (isPathfindingActive) processJourney(e.latlng, false, null);
            }
        });

        function processJourney(destLatLng, isBusStop, stopId) {
            if (!userLatLng) { alert("Waiting for user location..."); return; }
            clearRoutes(); 
            var distDirect = userLatLng.distanceTo(destLatLng);
            var startData = findNearestStop(userLatLng);
            var endStop = null;
            if (isBusStop && stopId) endStop = allStopsData.find(s => s.stop_id == stopId); 
            if(!endStop) { let n = findNearestStop(destLatLng); if(n.stop) endStop = n.stop; }
            var startStop = startData.stop;

            if (isBusStop && endStop && endStop.marker) {
                endStop.marker.openPopup();
            } else {
                destinationMarker = L.marker(destLatLng, {icon: iconDestination}).addTo(map);
                let msg = "Destination";
                if(endStop) msg += "<br><span style='font-size:11px;color:#097C87'>Nearest Stop: " + endStop.stop_name + "</span>";
                destinationMarker.bindPopup(msg, { offset: [0, 0] }).openPopup();
                if(endStop) openStopSidebar(endStop.stop_id, endStop.stop_name);
            }

            var useBus = false;
            if (startStop && endStop && startStop.stop_id !== endStop.stop_id) {
                var d1 = userLatLng.distanceTo(startStop.latLng); var d2 = endStop.latLng.distanceTo(destLatLng);
                if (distDirect > ABSOLUTE_MIN_WALK && distDirect > (d1+d2)) useBus = true;
            }

            var walkStyles = [ { color: '#6E8F72', opacity: 1, weight: 7, className: 'routing-line' }, { color: '#A1CCA6', opacity: 1, weight: 4, lineCap: 'round', dashArray: '1, 10', className: 'routing-line' } ];
            var busStyles = [ { color: '#054A52', opacity: 0.8, weight: 8, className: 'routing-line' }, { color: '#23CED9', opacity: 1, weight: 4, className: 'routing-line' } ];

            if (!useBus) {
                createRoute(userLatLng, destLatLng, walkStyles, 'walking');
            } else {
                if(startStop) { startStop.marker.setIcon(iconBusRed); startStop.marker.setZIndexOffset(1000); }
                if(endStop) { endStop.marker.setIcon(iconBusRed); endStop.marker.setZIndexOffset(1000); }
                createRoute(userLatLng, startStop.latLng, walkStyles, 'walking');
                createRoute(startStop.latLng, endStop.latLng, busStyles, 'driving'); 
                if (!isBusStop) createRoute(endStop.latLng, destLatLng, walkStyles, 'walking');
            }
            
            var bounds = [userLatLng, destLatLng];
            if(startStop) bounds.push(startStop.latLng); if(endStop) bounds.push(endStop.latLng);
            map.fitBounds(L.latLngBounds(bounds), {padding: [100, 100]}); 
        }

        function createRoute(start, end, styleStyles, mode) {
            var control = L.Routing.control({
                waypoints: [start, end],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: mode }),
                routeWhileDragging: false, addWaypoints: false, fitSelectedRoutes: false, show: false, createMarker: function() { return null; }, 
                lineOptions: { styles: styleStyles, missingRouteStyles: styleStyles, pane: 'routePane' } 
            }).addTo(map);
            routeControls.push(control);
        }

        // --- TOGGLE BUTTON ---
        const toggleBtn = document.getElementById('toggle-label-btn');
        const mapWrapper = document.getElementById('map-wrapper');

        toggleBtn.addEventListener('click', function() {
            isPathfindingActive = !isPathfindingActive;
            if (!isPathfindingActive) {
                clearRoutes(); 
                if(activeTripPolyline) { map.removeLayer(activeTripPolyline); activeTripPolyline = null; fetchMapDataFromBackend(); }
                liveBusLayerGroup.clearLayers(); 
                toggleBtn.innerHTML = "üö´"; toggleBtn.classList.add('disabled-mode');
                mapWrapper.classList.add('hide-routes'); closeSidebar();
            } else {
                toggleBtn.innerHTML = "üëÅÔ∏è"; toggleBtn.classList.remove('disabled-mode');
                mapWrapper.classList.remove('hide-routes');
                const pane = map.getPane('routePane'); pane.style.display = 'block'; 
            }
        });

        // --- SEARCH ---
        const searchInput = document.getElementById('search-input');
        const searchDropdown = document.getElementById('search-results-dropdown');
        let debounceTimer;
        searchInput.addEventListener('input', function(e) {
            if (!isPathfindingActive) return;
            const query = e.target.value.trim(); searchDropdown.innerHTML = '';
            if (query.length < 3) { searchDropdown.style.display = 'none'; return; }
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                try {
                    const promises = [ fetch(`${BACKEND_URL}/search_stations?query=${query}`).then(res=>res.json()).catch(()=>[]), fetch(`${NOMINATIM_URL}?format=json&q=${query}&addressdetails=1&limit=5`).then(res=>res.json()).catch(()=>[]) ];
                    const [stops, places] = await Promise.all(promises);
                    searchDropdown.innerHTML = '';
                    if(stops.length) {
                        const h=document.createElement('div'); h.className='search-header'; h.innerText='STOPS'; searchDropdown.appendChild(h);
                        stops.forEach(i=>{ const d=document.createElement('div'); d.className='search-suggestion-item'; d.innerHTML=`üöå ${i.stop_name}`; d.onclick=()=>{selectSearchResult(i,'stop')}; searchDropdown.appendChild(d); });
                    }
                    if(places.length) {
                        const h=document.createElement('div'); h.className='search-header'; h.innerText='PLACES'; searchDropdown.appendChild(h);
                        places.forEach(i=>{ const d=document.createElement('div'); d.className='search-suggestion-item'; d.innerHTML=`üìç ${i.display_name.split(',')[0]}`; d.onclick=()=>{selectSearchResult(i,'place')}; searchDropdown.appendChild(d); });
                    }
                    searchDropdown.style.display = (stops.length+places.length)?'block':'none';
                } catch(err){ console.error(err); }
            }, 400); 
        });

        async function selectSearchResult(item, type) {
            if (!isPathfindingActive) return;
            searchInput.value = type==='stop'?item.stop_name:item.display_name.split(',')[0];
            searchDropdown.style.display = 'none';
            const lat=parseFloat(item.lat||item.latitude); const lon=parseFloat(item.lon||item.longitude);
            const t=L.latLng(lat,lon);
            
            if(type==='stop') { 
                map.setView(t,16); 
                openStopSidebar(item.stop_id,item.stop_name);
                if(isPathfindingActive) processJourney(t,true,item.stop_id); 
                else clearRoutes();
            }
            else {
                if(!isPathfindingActive) return;
                map.setView(t,16);
                try {
                    const res = await fetch(`${BACKEND_URL}/map_data`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({north:t.lat+0.01, south:t.lat-0.01, east:t.lng+0.01, west:t.lng-0.01, buffer_meters:200, max_stops:100}) });
                    const d=await res.json();
                    if(d.type==="MapDataResponse") { updateMapWithBackendData(d.payload.stops); processJourney(t,false,null); }
                } catch(e) { destinationMarker=L.marker(t,{icon:iconDestination}).addTo(map); }
            }
        }
        document.getElementById('locate-btn').addEventListener('click', function() { navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true }); });
    </script>
</body>
</html>